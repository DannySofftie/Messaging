<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Call Options</title>
    <link type="text/css" href="/custom_style.css" rel="stylesheet" />
    <link type="text/css" href="/bootstrap.css" rel="stylesheet" />
    <link type="text/css" href="/animate.css" rel="stylesheet" />
    <link type="text/css" href="/materialdesignicons.css" rel="stylesheet" />
</head>
<body>
    <div class="bg-faded">
        <div class="jumbotron text-center bg-info" style="padding: 30px 0;">
            <div style="position: absolute; top: 2px; right: 2px;">
                <button class="btn btn-sm btn-danger" id="close_window">Close</button>
            </div>
            <h5>Choose how to call your friend.</h5>
            <button class="btn btn-success" id="audio_call">Audio call <span class="mdi mdi-microphone-settings"></span></button>
            <button class="btn btn-warning" id="video_call">Video call <span class="mdi mdi-video"></span></button>
        </div>
        <div>
            <span id="my_id">My id here</span><br />
            <span id="other_id"></span>
        </div>
        <div class="text-center">
            <video src="" id="video" style="width: 400px; height: 400px;" autoplay="autoplay"></video>
            <canvas id="preview" style="display: none"></canvas>
            <div id="logger"></div> 
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="/jquery-3.1.1.js"></script>
    <script src="/bootstrap.js"></script>
    <script src="/smooth-scroll.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/peer.js" ></script>

    <script>
        var video = $('#play');
      
        // extract url parameters by name to be used to initiate call
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        var $initiator_crypto = getParameterByName('initiator_crypto');
        var $receiver_crypto = getParameterByName('receiver_crypto');
        
        // create a peer and pass id of the receiver
        var peer = new Peer({host : 'localhost' , port : 7880, path : '/'});  
        // peer js will take control after having both keys here

        peer.on('open', function () {
            $('#my_id').text(peer.id);
        });

        var canvas = document.getElementById('preview');
        var context = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 600;
        context.width = canvas.width;
        context.height = canvas.height;

        var video = document.getElementById('video');
        var socket = io();

        function logger(message) {
            $('#logger').text(message);
        }

        function loadCamera(stream) {
            logger('Camera connection [OK]');
            video.src = window.URL.createObjectURL(stream);
        }

        function loadFailed() {
            logger('Your camera is not probably connected');
        }

        function viewVideo(video, context) {
            context.drawImage(video, 0, 0, context.width, context.height);
            socket.emit('stream', canvas.toDataURL('video/webp'));
        }


        $('#audio_call').click(function () {
            // handle audio calling
            navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);

            if (navigator.getUserMedia) {
                navigator.getUserMedia({ video: false, audio: true }, loadCamera, loadFailed);

            }

            setInterval(function () {
                viewVideo(video, context)
            }, 3000);
           
        });

        $('#video_call').click(function () {
            // handle video calling
            navigator.getUserMedia = (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia);

            if (navigator.getUserMedia) {
                navigator.getUserMedia({ video: true, audio: true }, loadCamera, loadFailed);

            }

            setInterval(function () {
                viewVideo(video, context)
            }, 3000);
        });

        $('#close_window').click(function () {
            window.close();
        })
        
    </script>
</body>
</html>


