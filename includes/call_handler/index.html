<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Call Options</title>
    <link type="text/css" href="./assets/bootstrap.css" rel="stylesheet" />
    <link type="text/css" href="./assets/animate.css" rel="stylesheet" />
    <link type="text/css" href="./assets/materialdesignicons.css" rel="stylesheet" />
</head>
<body>
    <div class="bg-faded">
        <div class="jumbotron text-center bg-info" style="padding: 30px 0;">
            <div style="position: absolute; top: 2px; right: 2px;">
                <button class="btn btn-sm btn-danger" id="close_window">Close</button>
            </div>
            <h5>Choose how to call your friend.</h5>
            <button class="btn btn-success" id="audio_call">Audio call <span class="mdi mdi-microphone-settings"></span></button>
            <button class="btn btn-warning" id="video_call">Video call <span class="mdi mdi-video"></span></button>
        </div>
        <div>
            <span id="my_id"></span><br />
            <audio id="audio_holder" controls autoplay="autoplay" style="display: none"></audio>
            <span id="other_id">The other id</span>
        </div>
        <div class="text-center">
            <video id="video_holder" style="width: 400px; height: 400px;" autoplay="autoplay"></video>
            <canvas id="preview" style="display: none"></canvas>
            <div id="logger">Logger body</div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="js/jquery-3.1.1.js"></script>
    <script src="js/tether.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/smooth-scroll.js"></script>
    <script src="js/peer.js"></script>
    <script>
        (function () {

            // make ajax to request user a random generated key
            $.ajax({
                url: '/requestUserData',
                method: 'GET',
                success: function (data) {
                    $('#my_id').html(data)
                },
                error: function (err) {
                    alert("An error occured")
                }
            })

            var peer = new Peer({ host: 'localhost', port: 7880, path: '/initiate' });

           
            var vendorURL = window.URL || window.webkitURL

            navigator.getMedia = navigator.getUserMedia ||
                                       navigator.webkitGetUserMedia ||
                                       navigator.mozGetUserMedia ||
                                       navigator.msGetUserMedia;

            //capture video
            $('#video_call').click(function () {
                if (navigator.getMedia) {
                    navigator.getMedia({
                        video: true,
                        audio: true
                    }, function (stream) {
                        // send this data stream to the other connected peer
                        var call = peer.call('other-peers-id', stream)

                        call.on('stream', function (remoteStream) {

                            // show this on a video stream
                            $('#video_holder').attr('src', vendorURL.createObjectURL(remoteStream))
                            $('#video_holder').play()
                            $('#logger').text('Camera and microphone [OK]')

                        })
                    }, function (error) {
                        $('#logger').text('An error occured. Check your camera')
                    })
                }
            })

            // capture audio
            $('#audio_call').click(function () {
                if (navigator.getMedia) {
                    navigator.getMedia({
                        video: false,
                        audio: true
                    }, function (stream) {
                        // send this data stream to the other connected peer
                        var call = peer.call('other-peers-id', stream)

                        $('#logger').text('Microphone [OK]')
                        call.on('stream', function (remoteStream) {

                            // show this on a video stream
                            $('#audio_holder').css('display', 'block')
                            $('#audio_holder').attr('src', vendorURL.createObjectURL(remoteStream))
                            $('#audio_holder').play();                          

                        })
                    }, function (error) {
                        $('#logger').text('Error initialising your microphone')
                    })
                }
            })


            // close this window on close click
            $('#close_window').click(function () {
                window.close();
            })
        })();
    </script>
</body>
</html>
